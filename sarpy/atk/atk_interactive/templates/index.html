<html>
  <head>
      <title>SAR Remapping Demonstration</title>
      <link href="{{ url_for('static', filename='vendors/leaflet/leaflet.css') }}" rel="stylesheet">
  </head>
  <body>

    <h1>SAR Remapping Demonstration</h1>

    <form>
        <label for="image_path_lbl">Image Path: </label>
        <input id="image_path" value="~/sarpy_data/nitf/sicd_example_1_PFA_RE32F_IM32F_HH.nitf" />
        <button id="load_image" type="button">Load Image</button>
    </form>

    <form>
        <label for="decimation_lbl">Decimation: </label>
        <input id="decimation" type="number" min="1" max="1000" value="10" step="1" />
    </form>

    <form>
        <label for="image_xmin_lbl">x min: </label>
        <input id="min_x" type="number" min="0" max="10000" value="0" step="1" />
        <label for="image_xmax_lbl">x max: </label>
        <input id="max_x" type="number" min="1" max="9999" value="1000" step="1" />
    </form>

    <form>
        <label for="image_ymin_lbl">y min: </label>
        <input id="min_y" type="number" min="0" max="10000" value="0" step="1" />
        <label for="image_ymax_lbl">y max: </label>
        <input id="max_y" type="number" min="1" max="9999" value="1000" step="1" />
    </form>

    <form>
        <button id="crop_button" type="button">Crop to bounds.</button>
    </form>

    <div id="mapid"></div>

    <form>
        <label for="image_path_ortho_lbl">Image Path Ortho: </label>
        <input id="image_path_ortho" value="~/sarpy_data/geoTiff/sicd_example_1_PFA_RE32F_IM32F_HH.tif" />
        <button id="ortho_image" type="button">Save Map Image</button>
    </form>

    <script src="{{ url_for('static', filename='vendors/leaflet/leaflet.js') }}"></script>
    <style>
         #mapid {
            position: relative;
            height: 300px;
            width: 500px;
        }
    </style>

    <script>
        dL = L.tileLayer('https://a.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>',
            maxZoom: 24,
        });
        var mymap = new L.map('mapid', {
            zoomControl: true,
            zoom: 4,
            // layers: [dL],
        });
        //mymap.panTo([39.97712, -109.160156]);

        let load_image = document.getElementById('load_image');
        load_image.addEventListener('click', updateImagePath);

        let decimation = document.getElementById('decimation');
        decimation.addEventListener('input', updateDecimation);

        let ortho_image = document.getElementById('ortho_image');
        ortho_image.addEventListener('click', orthoImage);

        let crop = document.getElementById('crop_button');
        crop.addEventListener('click', cropImage);

        function updateImagePath() {
            ROUTE_ADDRESS = 'update_image_path';
            let image_path = document.getElementById('image_path');
            callRoute(ROUTE_ADDRESS, image_path.value)
        }

        function updateDecimation() {
            ROUTE_ADDRESS = 'update_decimation';
            callRoute(ROUTE_ADDRESS, this.value)
        }

        function orthoImage() {
            ROUTE_ADDRESS = 'ortho_image';
            let output_image_path = document.getElementById('image_path_ortho')
            callRoute(ROUTE_ADDRESS, output_image_path.value)
        }

        function cropImage() {
            routeName = 'crop_image';
            let min_x = document.getElementById('min_x')
            let max_x = document.getElementById('max_x')
            let min_y = document.getElementById('min_y')
            let max_y = document.getElementById('max_y')

            xhr = new XMLHttpRequest();
            data = new FormData();

            data.append('minx', min_x.value);
            data.append('maxx', max_x.value);
            data.append('miny', min_y.value);
            data.append('maxy', max_y.value);

            xhr.open('POST', routeName);
            let token = "{{ csrf_token() }}";
            xhr.setRequestHeader("X-CSRFToken", token);
            xhr.send(data)

            xhr.onload = function(evt) {
                var resp;
                try {
                    resp = JSON.parse(xhr.response);
                    console.log(resp)
                } catch (error) {
                    console.error(error);
                }
            }
        }

        function callRoute(routeName, value) {

            xhr = new XMLHttpRequest();
            data = new FormData();

            data.append('input', value);
            xhr.open('POST', routeName);
            let token = "{{ csrf_token() }}";
            xhr.setRequestHeader("X-CSRFToken", token);
            xhr.send(data)

        }

    </script>
  </body>
</html>
